version: 2.1

orbs:
  # dev version needs to be manually deployed to accurately test commit changes.
  # Once deployed, update <alpha> to reflect the version deployed.
  ghpr: narrativescience/ghpr@dev:alpha

commands:
  pack-validate:
    description: Pack and validate the orb config
    steps:
      - run:
          name: Pack config
          command: circleci config pack src > orb.yml
      - run:
          name: Valid orb.yml
          command: circleci orb validate orb.yml

jobs:
  test:
    machine: true
    steps:
      - ghpr/get-pr-info:
          get_pr_author_email: true
          get_pr_author_name: true
          get_commit_message: true
      - ghpr/slack-pr-author:
          message: "slack by email should fal"
          get_slack_user_by: email
          when: always
      - ghpr/slack-pr-author:
          message: "slack by name should succeed"
          get_slack_user_by: display_name
          when: always
      - ghpr/slack-pr-author:
          message: "slack by real_name should fail"
          get_slack_user_by: real_name
          when: always
      - ghpr/slack-pr-author:
          message: "slack by title_tag should succeed"
          get_slack_user_by: title_tag
          when: always

  publish:
    machine: true
    steps:
      - pack-validate
      - run:
          name: Publish new orb version
          command: |
            # TODO figure out how to configure CLI so publishing works
            circleci orb publish orb.yml "narrativescience/ghpr@$CIRCLE_TAG"

workflows:
  pull_request:
    jobs:
      - test:
          context: opensource
          filters:
            branches:
              ignore:
                - master
  # TODO uncomment and make it possible to auto-publish
  # publish:
  #   jobs:
  #     - publish:
  #         context: opensource
  #         filters:
  #           tags:
  #             only: /v[0-9]+(\.[0-9]+)*/
  #           branches:
  #             ignore: /.*/
